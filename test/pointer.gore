var v1 i32 := -86
var v2 i32 := 420
var p1 *i32 := v1       // TODO "&" to get addr
var s str := "global string"

// TODO test pointer arithmetic

fn global_test() {
    printStr("p1 = &v1")

    printInt(v1)
    *p1 = -69
    printInt(v1)
    *p1 = v2
    printInt(v1)

    printStr("p1 = &v2")
    p1 = v2

    printInt(v2)
    *p1 = -13
    printInt(v2)
    *p1 = v1
    printInt(v2)
}

fn local_test() {
    var i1 i32 := 86
    var i2 i32 := -69

    printStr("p1 = &i1")
    var lp1 *i32 := i1

    printInt(i1)
    *lp1 = 420
    printInt(i1)
    *lp1 = i2
    printInt(i1)

    printStr("p1 = &i2")
    lp1 = i2

    printInt(i2)
    *lp1 = -420
    printInt(i2)
    *lp1 = i1
    printInt(i2)
}

fn test_deref_global() {
    printStr("(*p1) v2 = 86")
    v2 = 86
    printInt(*p1)


    printStr("*p1 = 2 * *p1 (2 * 86 = 172)")
              *p1 = 2 * *p1
    printInt(*p1)

    printStr("*p1 = *p1 / 2 (172 / 2 = 86)")
              *p1 = *p1 / 2
    printInt(*p1)

    printStr("*p1 = 2 * *p1 + 10 * 2 (2 * 86 + 10 * 2 = 192)")
              *p1 = 2 * *p1 + 10 * 2
    printInt(*p1)
}

fn test_deref_local() {
    var p2 *i32 := v2

    printStr("(*p2) v2 = 86")
    v2 = 86
    printInt(*p2)

    printStr("*p2 = 2 * *p2 (2 * 86 = 172)")
              *p2 = 2 * *p2
    printInt(*p2)

    printStr("*p2 = *p2 / 2 (172 / 2 = 86)")
              *p2 = *p2 / 2
    printInt(*p2)

    printStr("*p2 = 2 * *p2 + 10 * 2 (2 * 86 + 10 * 2 = 192)")
              *p2 = 2 * *p2 + 10 * 2
    printInt(*p2)
}

fn test_prints() {
    printStr("pointer to global vars")
    var p2 *i32 := v2

    printPtr(p1)
    printPtr(p2)

    printStr("pointer to local vars")
    var l1 i32 := 420
    var l2 i32 := 420

    var p3 *i32 := l1
    var p4 *i32 := l2

    printPtr(p3)
    printPtr(p4)

    var diff i32 := p4 - p1
    printStr("diff in byte:")
    printInt(diff)
    printStr("diff in MB (rounded):")
    printInt(diff / 1024 / 1024)
    printStr("~1MB difference -> size of stack")
}

fn test_str() {
    var s1 str := "local string"
    var s2 str := "local string2"
    var p2 *str := s
    var p3 *str := s1

    printStr("pointer to global str")
    printStr(s)

    *p2 = "test string"
    printStr(s)

    *p2 = s2
    printStr(s)

    printStr("pointer to local str")
    printStr(s1)

    *p3 = "test string2"
    printStr(s1)

    *p3 = s2
    printStr(s1)
}

fn main() {
    printStr("global pointer test")
    global_test()

    printStr("local pointer test")
    local_test()

    printStr("test deref global pointer")
    test_deref_global()

    printStr("test deref local pointer")
    test_deref_local()

    printStr("test printPtr")
    test_prints()

    printStr("test *str")
    test_str()
}
